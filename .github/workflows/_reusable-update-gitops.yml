name: Reusable - Update GitOps Repository

on:
  workflow_call:
    inputs:
      service-name:
        description: 'Service name (e.g., authentication-service)'
        required: true
        type: string
      image-tag:
        description: 'Docker image tag (typically commit SHA)'
        required: true
        type: string
      dockerhub-username:
        description: 'Docker Hub username'
        required: true
        type: string
    secrets:
      GITOPS_REPO:
        required: true
      GITOPS_TOKEN:
        required: true

jobs:
  update-gitops:
    name: Update ${{ inputs.service-name }} in GitOps
    runs-on: ubuntu-latest
    steps:
      - name: Validate GitOps configuration
        run: |
          echo "üîç Validating GitOps configuration..."
          if [[ -z "${{ secrets.GITOPS_REPO }}" ]]; then
            echo "‚ùå ERROR: GITOPS_REPO secret is not set"
            exit 1
          fi
          if [[ -z "${{ secrets.GITOPS_TOKEN }}" ]]; then
            echo "‚ùå ERROR: GITOPS_TOKEN secret is not set"
            exit 1
          fi

          # Validate GITOPS_REPO format (should be owner/repo, not full URL)
          REPO="${{ secrets.GITOPS_REPO }}"
          if [[ "$REPO" == https://* ]] || [[ "$REPO" == http://* ]]; then
            echo "‚ùå ERROR: GITOPS_REPO should be in format 'owner/repo', not a full URL"
            echo "   Current format appears to be a URL"
            echo "   Expected: group-2-odp-bni/orange-wallet-gitops"
            exit 1
          fi

          echo "‚úÖ GitOps configuration validated"
          echo "   Repository: ${REPO}"

      - name: Checkout GitOps repository
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.GITOPS_REPO }}
          token: ${{ secrets.GITOPS_TOKEN }}
          path: gitops
          fetch-depth: 1

      - name: Update image tag in production overlay
        working-directory: gitops
        run: |
          SERVICE_DIR="production/${{ inputs.service-name }}"
          KUSTOMIZATION_FILE="${SERVICE_DIR}/kustomization.yaml"

          echo "========================================"
          echo "Updating GitOps Repository"
          echo "========================================"
          echo "Service: ${{ inputs.service-name }}"
          echo "Image Tag: ${{ inputs.image-tag }}"
          echo "File: ${KUSTOMIZATION_FILE}"
          echo ""

          # Update newTag using yq
          yq eval '.images[0].newTag = "${{ inputs.image-tag }}"' -i "${KUSTOMIZATION_FILE}"

          # Also ensure newName is correct (in case it changed)
          yq eval '.images[0].newName = "docker.io/${{ inputs.dockerhub-username }}/orange-wallet-${{ inputs.service-name }}"' -i "${KUSTOMIZATION_FILE}"

          echo "Updated kustomization.yaml:"
          echo "---"
          cat "${KUSTOMIZATION_FILE}"
          echo "---"

      - name: Commit and push changes
        working-directory: gitops
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add production/${{ inputs.service-name }}/kustomization.yaml

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è No changes to commit (image tag already up to date)"
            echo "current_tag=${{ inputs.image-tag }}" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Commit with descriptive message using heredoc
          git commit -m "$(cat <<EOF
          chore: update ${{ inputs.service-name }} to ${{ inputs.image-tag }}

          Automated update from CI/CD pipeline

          Service: ${{ inputs.service-name }}
          Image: ${{ inputs.dockerhub-username }}/orange-wallet-${{ inputs.service-name }}:${{ inputs.image-tag }}
          Source Commit: ${{ github.sha }}
          Workflow: ${{ github.workflow }}
          Run: ${{ github.run_number }}
          Actor: ${{ github.actor }}
          EOF
          )"

          echo "üì§ Pushing to GitOps repository..."

          # Retry push with pull --rebase to handle concurrent updates
          MAX_RETRIES=5
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if git push origin main; then
              echo "‚úÖ GitOps repository updated successfully"
              echo "new_tag=${{ inputs.image-tag }}" >> $GITHUB_OUTPUT
              exit 0
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "‚ö†Ô∏è Push failed (attempt $RETRY_COUNT/$MAX_RETRIES). Pulling latest changes..."

              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                # Pull with rebase to integrate remote changes
                git pull --rebase origin main

                # Check if rebase had conflicts
                if [ $? -ne 0 ]; then
                  echo "‚ùå Rebase conflict detected. Aborting and retrying from fresh clone..."
                  git rebase --abort

                  # Fetch and reset to remote, then re-apply our changes
                  git fetch origin main
                  git reset --hard origin/main

                  # Re-apply the image tag update
                  yq eval '.images[0].newTag = "${{ inputs.image-tag }}"' -i "production/${{ inputs.service-name }}/kustomization.yaml"
                  yq eval '.images[0].newName = "docker.io/${{ inputs.dockerhub-username }}/orange-wallet-${{ inputs.service-name }}"' -i "production/${{ inputs.service-name }}/kustomization.yaml"

                  git add production/${{ inputs.service-name }}/kustomization.yaml
                  git commit -m "$(cat <<EOF
          chore: update ${{ inputs.service-name }} to ${{ inputs.image-tag }}

          Automated update from CI/CD pipeline

          Service: ${{ inputs.service-name }}
          Image: ${{ inputs.dockerhub-username }}/orange-wallet-${{ inputs.service-name }}:${{ inputs.image-tag }}
          Source Commit: ${{ github.sha }}
          Workflow: ${{ github.workflow }}
          Run: ${{ github.run_number }}
          Actor: ${{ github.actor }}
          EOF
          )" || true
                fi

                # Wait before retry with exponential backoff
                WAIT_TIME=$((2 ** RETRY_COUNT))
                echo "‚è≥ Waiting ${WAIT_TIME}s before retry..."
                sleep $WAIT_TIME
              fi
            fi
          done

          echo "‚ùå Failed to push after $MAX_RETRIES attempts"
          exit 1

      - name: Create deployment summary
        run: |
          # Get the latest commit hash from gitops repo
          GITOPS_COMMIT=$(git -C gitops rev-parse HEAD)

          echo "### ‚úÖ GitOps Repository Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** \`${{ inputs.service-name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`docker.io/${{ inputs.dockerhub-username }}/orange-wallet-${{ inputs.service-name }}:${{ inputs.image-tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**GitOps Repository:** \`${{ secrets.GITOPS_REPO }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Source Commit:** \`${{ inputs.image-tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**GitOps Commit:** [\`${GITOPS_COMMIT:0:7}\`](https://github.com/${{ secrets.GITOPS_REPO }}/commit/${GITOPS_COMMIT})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üîÑ **ArgoCD will automatically sync this change within 3 minutes.**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Monitor deployment:**" >> $GITHUB_STEP_SUMMARY
          echo "- CLI: \`kubectl get pods -n orange-wallet -l app=${{ inputs.service-name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Logs: \`kubectl logs -n orange-wallet -l app=${{ inputs.service-name }} --tail=50\`" >> $GITHUB_STEP_SUMMARY
