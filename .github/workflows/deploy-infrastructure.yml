name: Deploy Infrastructure to K3s

on:
  workflow_dispatch:
    inputs:
      components:
        description: 'Components to deploy (comma-separated: postgres,redis,kafka or "all")'
        required: true
        default: 'all'
      confirm:
        description: 'Type "DEPLOY" to confirm infrastructure deployment'
        required: true

env:
  NAMESPACE: orange-wallet

jobs:
  validate-input:
    name: Validate Deployment Input
    runs-on: ubuntu-latest
    steps:
      - name: Validate confirmation
        run: |
          if [[ "${{ github.event.inputs.confirm }}" != "DEPLOY" ]]; then
            echo "‚ùå Deployment cancelled. You must type 'DEPLOY' to confirm."
            exit 1
          fi
          echo "‚úÖ Confirmation validated"

      - name: Show deployment plan
        run: |
          echo "=========================================="
          echo "üèóÔ∏è  INFRASTRUCTURE DEPLOYMENT PLAN"
          echo "=========================================="
          echo ""
          echo "Namespace: ${{ env.NAMESPACE }}"
          echo "Components: ${{ github.event.inputs.components }}"
          echo "Triggered by: ${{ github.actor }}"
          echo ""
          echo "‚ö†Ô∏è  WARNING: This will deploy stateful services!"
          echo "‚ö†Ô∏è  Make sure you understand the implications."
          echo ""

  deploy-infrastructure:
    name: Deploy Infrastructure Components
    runs-on: ubuntu-latest
    needs: validate-input
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.14.0'

      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Verify cluster connection
        run: |
          echo "Connecting to K3s cluster..."
          kubectl cluster-info
          kubectl get nodes
          echo ""
          echo "‚úÖ Connected to cluster"

      - name: Create namespace if not exists
        run: |
          kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
          echo "‚úÖ Namespace ready"

      - name: Create infrastructure secrets
        run: |
          echo "Creating PostgreSQL secret for infrastructure..."
          # Note: postgres-secret is for PostgreSQL pod itself
          # Application secrets (app-secrets) are managed by cd-k3s.yml
          kubectl create secret generic postgres-secret \
            --from-literal=username="${{ secrets.DB_USERNAME }}" \
            --from-literal=password="${{ secrets.DB_PASSWORD }}" \
            --from-literal=database="${{ secrets.DB_NAME }}" \
            --namespace=${{ env.NAMESPACE }} \
            --dry-run=client -o yaml | kubectl apply -f -

          echo "‚úÖ Infrastructure secrets created"

      - name: Determine components to deploy
        id: components
        run: |
          COMPONENTS="${{ github.event.inputs.components }}"

          if [[ "$COMPONENTS" == "all" ]]; then
            echo "deploy_postgres=true" >> $GITHUB_OUTPUT
            echo "deploy_redis=true" >> $GITHUB_OUTPUT
            echo "deploy_kafka=true" >> $GITHUB_OUTPUT
          else
            echo "deploy_postgres=false" >> $GITHUB_OUTPUT
            echo "deploy_redis=false" >> $GITHUB_OUTPUT
            echo "deploy_kafka=false" >> $GITHUB_OUTPUT

            IFS=',' read -ra SELECTED <<< "$COMPONENTS"
            for component in "${SELECTED[@]}"; do
              component=$(echo "$component" | xargs)
              case "$component" in
                postgres|postgresql)
                  echo "deploy_postgres=true" >> $GITHUB_OUTPUT
                  ;;
                redis)
                  echo "deploy_redis=true" >> $GITHUB_OUTPUT
                  ;;
                kafka)
                  echo "deploy_kafka=true" >> $GITHUB_OUTPUT
                  ;;
              esac
            done
          fi

      - name: Deploy PostgreSQL
        if: steps.components.outputs.deploy_postgres == 'true'
        run: |
          echo "=========================================="
          echo "Deploying PostgreSQL..."
          echo "=========================================="

          helm upgrade --install postgres .k8s/charts/infrastructure/postgresql \
            --namespace ${{ env.NAMESPACE }} \
            --wait \
            --timeout 10m \
            --create-namespace

          echo ""
          echo "‚úÖ PostgreSQL deployed"

          echo "Waiting for PostgreSQL to be ready..."
          kubectl wait --for=condition=ready pod -l app=postgres \
            -n ${{ env.NAMESPACE }} \
            --timeout=300s

          echo "‚úÖ PostgreSQL is ready"

      - name: Deploy Redis
        if: steps.components.outputs.deploy_redis == 'true'
        run: |
          echo "=========================================="
          echo "Deploying Redis..."
          echo "=========================================="

          helm upgrade --install redis .k8s/charts/infrastructure/redis \
            --namespace ${{ env.NAMESPACE }} \
            --wait \
            --timeout 10m \
            --create-namespace

          echo ""
          echo "‚úÖ Redis deployed"

          echo "Waiting for Redis to be ready..."
          kubectl wait --for=condition=ready pod -l app=redis \
            -n ${{ env.NAMESPACE }} \
            --timeout=300s

          echo "‚úÖ Redis is ready"

      - name: Deploy Kafka
        if: steps.components.outputs.deploy_kafka == 'true'
        run: |
          echo "=========================================="
          echo "Deploying Kafka..."
          echo "=========================================="

          helm upgrade --install kafka .k8s/charts/infrastructure/kafka \
            --namespace ${{ env.NAMESPACE }} \
            --wait \
            --timeout 10m \
            --create-namespace

          echo ""
          echo "‚úÖ Kafka deployed"

          echo "Waiting for Kafka to be ready..."
          kubectl wait --for=condition=ready pod -l app=kafka \
            -n ${{ env.NAMESPACE }} \
            --timeout=300s

          echo "‚úÖ Kafka is ready"

      - name: Verify infrastructure deployment
        run: |
          echo "=========================================="
          echo "Infrastructure Status"
          echo "=========================================="
          echo ""

          echo "=== Pods ==="
          kubectl get pods -n ${{ env.NAMESPACE }} -l tier=infrastructure
          echo ""

          echo "=== Services ==="
          kubectl get svc -n ${{ env.NAMESPACE }} -l tier=infrastructure
          echo ""

          echo "=== Persistent Volume Claims ==="
          kubectl get pvc -n ${{ env.NAMESPACE }}
          echo ""

      - name: Deployment summary
        if: always()
        run: |
          echo "=========================================="
          echo "üèóÔ∏è  Infrastructure Deployment Summary"
          echo "=========================================="
          echo ""
          echo "Namespace: ${{ env.NAMESPACE }}"
          echo "Components requested: ${{ github.event.inputs.components }}"
          echo ""
          echo "Deployed components:"
          [[ "${{ steps.components.outputs.deploy_postgres }}" == "true" ]] && echo "  ‚úÖ PostgreSQL"
          [[ "${{ steps.components.outputs.deploy_redis }}" == "true" ]] && echo "  ‚úÖ Redis"
          [[ "${{ steps.components.outputs.deploy_kafka }}" == "true" ]] && echo "  ‚úÖ Kafka"
          echo ""
          echo "Triggered by: ${{ github.actor }}"
          echo "Completed at: $(date -u)"
          echo ""
          echo "‚ö†Ô∏è  IMPORTANT NOTES:"
          echo "  - Infrastructure is now running"
          echo "  - Data is persistent via PVCs"
          echo "  - To remove, use: helm uninstall <component> -n ${{ env.NAMESPACE }}"
          echo "  - Deleting PVCs will DELETE ALL DATA!"
          echo ""
