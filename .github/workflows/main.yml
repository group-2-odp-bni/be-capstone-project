name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
  pull_request:
    types: [opened, synchronize, reopened]

env:
  JAVA_VERSION: '21'
  JAVA_DISTRIBUTION: 'temurin'

jobs:
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      api-gateway: ${{ steps.filter.outputs.api-gateway }}
      authentication-service: ${{ steps.filter.outputs.authentication-service }}
      wallet-service: ${{ steps.filter.outputs.wallet-service }}
      transaction-service: ${{ steps.filter.outputs.transaction-service }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            api-gateway:
              - 'api-gateway/**'
            authentication-service:
              - 'authentication-service/**'
            wallet-service:
              - 'wallet-service/**'
            transaction-service:
              - 'transaction-service/**'

  build-api-gateway:
    name: Build & Test - api-gateway
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.api-gateway == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
      - name: Build & Test
        working-directory: api-gateway
        run: |
          chmod +x gradlew
          ./gradlew build test --no-daemon --stacktrace
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-api-gateway
          path: api-gateway/build/test-results/test/
          retention-days: 30

  build-authentication:
    name: Build & Test - authentication-service
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.authentication-service == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
      - name: Build & Test
        working-directory: authentication-service
        run: |
          chmod +x gradlew
          ./gradlew build test --no-daemon --stacktrace
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-authentication-service
          path: authentication-service/build/test-results/test/
          retention-days: 30

  build-wallet:
    name: Build & Test - wallet-service
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.wallet-service == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
      - name: Build & Test
        working-directory: wallet-service
        run: |
          chmod +x gradlew
          ./gradlew build test --no-daemon --stacktrace
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-wallet-service
          path: wallet-service/build/test-results/test/
          retention-days: 30

  build-transaction:
    name: Build & Test - transaction-service
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.transaction-service == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
      - name: Build & Test
        working-directory: transaction-service
        run: |
          chmod +x gradlew
          ./gradlew build test --no-daemon --stacktrace
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-transaction-service
          path: transaction-service/build/test-results/test/
          retention-days: 30

  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs:
      - detect-changes
      - build-api-gateway
      - build-authentication
      - build-wallet
      - build-transaction
    if: always()
    steps:
      - name: Summary
        run: |
          echo "üì¶ Build Summary"
          echo "======================"
          echo "üîç Detected Changes:"
          echo " - api-gateway: ${{ needs.detect-changes.outputs.api-gateway }}"
          echo " - authentication-service: ${{ needs.detect-changes.outputs.authentication-service }}"
          echo " - wallet-service: ${{ needs.detect-changes.outputs.wallet-service }}"
          echo " - transaction-service: ${{ needs.detect-changes.outputs.transaction-service }}"
          echo ""
          echo "üîß Build Results:"
          echo " - api-gateway: ${{ needs.build-api-gateway.result }}"
          echo " - authentication-service: ${{ needs.build-authentication.result }}"
          echo " - wallet-service: ${{ needs.build-wallet.result }}"
          echo " - transaction-service: ${{ needs.build-transaction.result }}"
          echo ""

          FAILED=false

          if [ "${{ needs.build-api-gateway.result }}" == "failure" ]; then
            echo "‚ùå api-gateway build failed"
            FAILED=true
          fi
          if [ "${{ needs.build-authentication.result }}" == "failure" ]; then
            echo "‚ùå authentication-service build failed"
            FAILED=true
          fi
          if [ "${{ needs.build-wallet.result }}" == "failure" ]; then
            echo "‚ùå wallet-service build failed"
            FAILED=true
          fi
          if [ "${{ needs.build-transaction.result }}" == "failure" ]; then
            echo "‚ùå transaction-service build failed"
            FAILED=true
          fi

          if [ "$FAILED" = true ]; then
            echo ""
            echo "üö® One or more builds failed. Stopping pipeline."
            exit 1
          else
            echo "‚úÖ All builds passed or were skipped."
          fi
