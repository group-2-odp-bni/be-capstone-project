name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
  pull_request:
    types: [opened, synchronize, reopened]

env:
  JAVA_VERSION: '21'
  JAVA_DISTRIBUTION: 'temurin'

jobs:
  discover-services:
    name: Discover Services
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.discover.outputs.services }}
      changed-services: ${{ steps.filter.outputs.changed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Discover all services
        id: discover
        run: |
          services=$(find . -maxdepth 2 -name "build.gradle*" -o -name "gradlew" | \
            sed 's|/build.gradle.*||' | sed 's|/gradlew||' | sed 's|^\./||' | \
            grep -E '(service|gateway)' | sort -u | jq -R -s -c 'split("\n")[:-1]')
          echo "services=$services" >> $GITHUB_OUTPUT

      - name: Detect changed services
        id: filter
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          else
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          fi

          CHANGED_SERVICES=$(echo "$CHANGED_FILES" | grep -E '^([^/]+)/' | cut -d'/' -f1 | \
            grep -E '(service|gateway)' | sort -u | jq -R -s -c 'split("\n")[:-1]')

          if [ -z "$CHANGED_SERVICES" ] || [ "$CHANGED_SERVICES" == '[""]' ] || [ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]; then
            CHANGED_SERVICES='${{ steps.discover.outputs.services }}'
          fi

          echo "changed=$CHANGED_SERVICES" >> $GITHUB_OUTPUT

  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    needs: discover-services
    if: needs.discover-services.outputs.changed-services != '[]' && needs.discover-services.outputs.changed-services != '[""]'
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.discover-services.outputs.changed-services) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Build & Test ${{ matrix.service }}
        working-directory: ${{ matrix.service }}
        run: |
          chmod +x gradlew
          ./gradlew clean build jacocoTestReport --no-daemon --stacktrace --info

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.service }}
          path: |
            ${{ matrix.service }}/build/
          retention-days: 1
          if-no-files-found: warn

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.service }}
          path: ${{ matrix.service }}/build/test-results/test/
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-${{ matrix.service }}
          path: ${{ matrix.service }}/build/reports/
          retention-days: 30
          if-no-files-found: ignore

  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [discover-services, build-and-test]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "üì¶ Build Summary"
          echo "======================"
          echo ""
          echo "üîç All Services:"
          echo '${{ needs.discover-services.outputs.services }}' | jq -r '.[]' | while read service; do
            echo " - $service"
          done
          echo ""
          echo "üîß Changed/Built Services:"
          echo '${{ needs.discover-services.outputs.changed-services }}' | jq -r '.[]' | while read service; do
            echo " - $service"
          done
          echo ""
          echo "üìä Build Result: ${{ needs.build-and-test.result }}"
          echo ""

          if [ "${{ needs.build-and-test.result }}" == "failure" ]; then
            echo "üö® One or more builds failed. Stopping pipeline."
            exit 1
          else
            echo "‚úÖ All builds passed or were skipped."
          fi

  sonar-project-setup:
    name: Setup SonarCloud Projects
    runs-on: ubuntu-latest
    needs: discover-services
    if: |
      needs.discover-services.outputs.changed-services != '[]' &&
      needs.discover-services.outputs.changed-services != '[""]'
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.discover-services.outputs.changed-services) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract SonarCloud Configuration
        id: extract-config
        working-directory: ${{ matrix.service }}
        run: |
          if [ -f gradle.properties ]; then
            PROJECT_KEY=$(grep "sonar.projectKey=" gradle.properties | cut -d'=' -f2)
            ORG=$(grep "sonar.organization=" gradle.properties | cut -d'=' -f2)
            echo "project_key=$PROJECT_KEY" >> $GITHUB_OUTPUT
            echo "organization=$ORG" >> $GITHUB_OUTPUT
            echo "‚úÖ Found project key: $PROJECT_KEY"
          else
            echo "‚ö†Ô∏è  No gradle.properties found, skipping"
            echo "project_key=" >> $GITHUB_OUTPUT
          fi

      - name: Check if SonarCloud Project Exists
        id: check-project
        if: steps.extract-config.outputs.project_key != ''
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          if [ -z "$SONAR_TOKEN" ]; then
            echo "‚ö†Ô∏è  SONAR_TOKEN not set, skipping SonarCloud setup"
            echo "exists=skip" >> $GITHUB_OUTPUT
            exit 0
          fi

          PROJECT_KEY="${{ steps.extract-config.outputs.project_key }}"
          ORG="${{ steps.extract-config.outputs.organization }}"

          echo "üîç Checking if project exists: $PROJECT_KEY"

          HTTP_CODE=$(curl -s -o /tmp/response.json -w "%{http_code}" -u "$SONAR_TOKEN:" \
            "https://sonarcloud.io/api/projects/search?projects=$PROJECT_KEY&organization=$ORG")

          if [ "$HTTP_CODE" = "200" ]; then
            COUNT=$(jq -r '.components | length // 0' /tmp/response.json)
            echo "üìä API Response: HTTP $HTTP_CODE, Found $COUNT project(s)"

            if [ "$COUNT" -gt 0 ]; then
              echo "exists=true" >> $GITHUB_OUTPUT
              echo "‚úÖ Project already exists in SonarCloud"
            else
              echo "exists=false" >> $GITHUB_OUTPUT
              echo "‚ö†Ô∏è  Project does not exist, will create"
            fi
          else
            echo "‚ö†Ô∏è  Failed to check project existence (HTTP $HTTP_CODE)"
            cat /tmp/response.json
            echo "exists=unknown" >> $GITHUB_OUTPUT
          fi

      - name: Create SonarCloud Project
        if: |
          steps.extract-config.outputs.project_key != '' &&
          steps.check-project.outputs.exists == 'false'
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          if [ -z "$SONAR_TOKEN" ]; then
            echo "‚ö†Ô∏è  SONAR_TOKEN not set, skipping project creation"
            exit 0
          fi

          PROJECT_KEY="${{ steps.extract-config.outputs.project_key }}"
          ORG="${{ steps.extract-config.outputs.organization }}"
          SERVICE_NAME="${{ matrix.service }}"
          DISPLAY_NAME=$(echo "$SERVICE_NAME" | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) tolower(substr($i,2))}1')

          echo "üöÄ Creating SonarCloud project: $PROJECT_KEY in organization: $ORG"

          HTTP_CODE=$(curl -s -o /tmp/create_response.json -w "%{http_code}" -X POST \
            -u "$SONAR_TOKEN:" \
            "https://sonarcloud.io/api/projects/create" \
            -d "organization=$ORG" \
            -d "project=$PROJECT_KEY" \
            -d "name=$DISPLAY_NAME" \
            -d "mainBranch=main")

          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Project created successfully"
          elif [ "$HTTP_CODE" = "400" ]; then
            ERROR_MSG=$(jq -r '.errors[0].msg // "Unknown error"' /tmp/create_response.json)
            if echo "$ERROR_MSG" | grep -q "already exists"; then
              echo "‚ÑπÔ∏è  Project already exists (HTTP $HTTP_CODE)"
            else
              echo "‚ö†Ô∏è  Project creation failed: $ERROR_MSG"
              echo "::warning::Project creation failed: $ERROR_MSG"
            fi
          else
            echo "‚ö†Ô∏è  Project creation returned HTTP $HTTP_CODE"
            cat /tmp/create_response.json
            echo "::warning::Project creation failed with HTTP $HTTP_CODE"
          fi

  sonar-analysis:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    needs:
      - discover-services
      - build-and-test
      - sonar-project-setup
    if: needs.build-and-test.result == 'success'
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.discover-services.outputs.changed-services) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: ${{ runner.os }}-gradle

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-${{ matrix.service }}
          path: ${{ matrix.service }}/build/

      - name: Check if test directory exists
        id: check-test-dir
        working-directory: ${{ matrix.service }}
        run: |
          if [ -d "src/test" ]; then
            echo "has_tests=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Test directory found, will run SonarCloud analysis"
          else
            echo "has_tests=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è No 'src/test' directory found in ${{ matrix.service }}, skipping SonarCloud analysis"
          fi

      - name: Verify build artifacts
        if: steps.check-test-dir.outputs.has_tests == 'true'
        working-directory: ${{ matrix.service }}
        run: |
          echo "üì¶ Verifying downloaded artifacts..."
          echo ""
          echo "Build classes:"
          ls -lah build/classes/java/main/ 2>/dev/null || echo "‚ö†Ô∏è No main classes found"
          echo ""
          echo "Test results:"
          ls -lah build/test-results/test/ 2>/dev/null || echo "‚ö†Ô∏è No test results found"
          echo ""
          echo "JaCoCo reports:"
          ls -lah build/reports/jacoco/test/ 2>/dev/null || echo "‚ö†Ô∏è No JaCoCo reports found"
          echo ""
          if [ -f "build/reports/jacoco/test/jacocoTestReport.xml" ]; then
            echo "‚úÖ JaCoCo XML report found for SonarCloud"
          else
            echo "‚ö†Ô∏è JaCoCo XML report not found, coverage may not be reported"
          fi

      - name: Run SonarCloud analysis for ${{ matrix.service }}
        if: steps.check-test-dir.outputs.has_tests == 'true'
        working-directory: ${{ matrix.service }}
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -z "$SONAR_TOKEN" ]; then
            echo "‚ö†Ô∏è  SONAR_TOKEN not set, skipping SonarCloud analysis"
            exit 0
          fi

          if [ ! -f gradle.properties ]; then
            echo "‚ö†Ô∏è No gradle.properties found, skipping SonarCloud analysis"
            exit 0
          fi

          ORG=$(grep "sonar.organization=" gradle.properties | cut -d'=' -f2)
          KEY=$(grep "sonar.projectKey=" gradle.properties | cut -d'=' -f2)

          # Determine analysis type and configure parameters accordingly
          SONAR_ARGS=""
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "üîç Running SonarCloud PR analysis for ${{ matrix.service }}"
            echo "   Type: Pull Request #${{ github.event.pull_request.number }}"
            echo "   Source Branch: ${{ github.head_ref }}"
            echo "   Target Branch: ${{ github.base_ref }}"
            SONAR_ARGS="-Dsonar.pullrequest.key=${{ github.event.pull_request.number }} \
              -Dsonar.pullrequest.branch=${{ github.head_ref }} \
              -Dsonar.pullrequest.base=${{ github.base_ref }}"
          else
            echo "üîç Running SonarCloud branch analysis for ${{ matrix.service }}"
            echo "   Type: Branch Push"
            echo "   Branch: ${{ github.ref_name }}"
            SONAR_ARGS="-Dsonar.branch.name=${{ github.ref_name }}"
          fi

          echo "   Organization: $ORG"
          echo "   Project Key: $KEY"
          echo "   Host: https://sonarcloud.io"
          echo ""

          chmod +x gradlew

          # Run sonar analysis only (skip build and test since we have artifacts)
          ./gradlew sonar --no-daemon --info \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.organization=$ORG \
            -Dsonar.projectKey=$KEY \
            -Dsonar.token=$SONAR_TOKEN \
            -Dsonar.scm.provider=git \
            $SONAR_ARGS \
            -x test -x build
