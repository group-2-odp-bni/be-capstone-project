name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
  pull_request:
    types: [opened, synchronize, reopened]

env:
  JAVA_VERSION: '21'
  JAVA_DISTRIBUTION: 'temurin'

jobs:
  discover-services:
    name: Discover Services
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.discover.outputs.services }}
      changed-services: ${{ steps.filter.outputs.changed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Discover all services
        id: discover
        run: |
          services=$(find . -maxdepth 2 -name "build.gradle*" -o -name "gradlew" | \
            sed 's|/build.gradle.*||' | sed 's|/gradlew||' | sed 's|^\./||' | \
            grep -E '(service|gateway)' | sort -u | jq -R -s -c 'split("\n")[:-1]')
          echo "services=$services" >> $GITHUB_OUTPUT

      - name: Detect changed services
        id: filter
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          else
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          fi

          CHANGED_SERVICES=$(echo "$CHANGED_FILES" | grep -E '^([^/]+)/' | cut -d'/' -f1 | \
            grep -E '(service|gateway)' | sort -u | jq -R -s -c 'split("\n")[:-1]')

          if [ -z "$CHANGED_SERVICES" ] || [ "$CHANGED_SERVICES" == '[""]' ] || [ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]; then
            CHANGED_SERVICES='${{ steps.discover.outputs.services }}'
          fi

          echo "changed=$CHANGED_SERVICES" >> $GITHUB_OUTPUT

  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    needs: discover-services
    if: needs.discover-services.outputs.changed-services != '[]' && needs.discover-services.outputs.changed-services != '[""]'
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.discover-services.outputs.changed-services) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Build & Test ${{ matrix.service }}
        working-directory: ${{ matrix.service }}
        run: |
          chmod +x gradlew
          ./gradlew build test --no-daemon --stacktrace

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.service }}
          path: ${{ matrix.service }}/build/test-results/test/
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.service }}
          path: ${{ matrix.service }}/build/reports/
          retention-days: 30
          if-no-files-found: ignore

  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [discover-services, build-and-test]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "üì¶ Build Summary"
          echo "======================"
          echo ""
          echo "üîç All Services:"
          echo '${{ needs.discover-services.outputs.services }}' | jq -r '.[]' | while read service; do
            echo " - $service"
          done
          echo ""
          echo "üîß Changed/Built Services:"
          echo '${{ needs.discover-services.outputs.changed-services }}' | jq -r '.[]' | while read service; do
            echo " - $service"
          done
          echo ""
          echo "üìä Build Result: ${{ needs.build-and-test.result }}"
          echo ""

          if [ "${{ needs.build-and-test.result }}" == "failure" ]; then
            echo "üö® One or more builds failed. Stopping pipeline."
            exit 1
          else
            echo "‚úÖ All builds passed or were skipped."
          fi

  sonar-project-setup:
    name: Setup SonarCloud Projects
    runs-on: ubuntu-latest
    needs: discover-services
    if: |
      needs.discover-services.outputs.changed-services != '[]' &&
      needs.discover-services.outputs.changed-services != '[""]' &&
      secrets.SONAR_TOKEN != ''
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.discover-services.outputs.changed-services) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract SonarCloud Configuration
        id: extract-config
        working-directory: ${{ matrix.service }}
        run: |
          if [ -f gradle.properties ]; then
            PROJECT_KEY=$(grep "sonar.projectKey=" gradle.properties | cut -d'=' -f2)
            ORG=$(grep "sonar.organization=" gradle.properties | cut -d'=' -f2)
            echo "project_key=$PROJECT_KEY" >> $GITHUB_OUTPUT
            echo "organization=$ORG" >> $GITHUB_OUTPUT
            echo "‚úÖ Found project key: $PROJECT_KEY"
          else
            echo "‚ö†Ô∏è  No gradle.properties found, skipping"
            echo "project_key=" >> $GITHUB_OUTPUT
          fi

      - name: Check if SonarCloud Project Exists
        id: check-project
        if: steps.extract-config.outputs.project_key != ''
        continue-on-error: true
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          PROJECT_KEY="${{ steps.extract-config.outputs.project_key }}"

          echo "üîç Checking if project exists: $PROJECT_KEY"

          RESPONSE=$(curl -s -u "$SONAR_TOKEN:" \
            "https://sonarcloud.io/api/projects/search?projects=$PROJECT_KEY")

          COUNT=$(echo "$RESPONSE" | jq -r '.components | length // 0')

          if [ "$COUNT" -gt 0 ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Project exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Project does not exist, will create"
          fi

      - name: Create SonarCloud Project
        if: |
          steps.extract-config.outputs.project_key != '' &&
          steps.check-project.outputs.exists == 'false'
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          PROJECT_KEY="${{ steps.extract-config.outputs.project_key }}"
          ORG="${{ steps.extract-config.outputs.organization }}"
          SERVICE_NAME="${{ matrix.service }}"
          DISPLAY_NAME=$(echo "$SERVICE_NAME" | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) tolower(substr($i,2))}1')

          echo "üöÄ Creating SonarCloud project: $PROJECT_KEY"

          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST \
            -u "$SONAR_TOKEN:" \
            "https://sonarcloud.io/api/projects/create" \
            -d "organization=$ORG" \
            -d "project=$PROJECT_KEY" \
            -d "name=$DISPLAY_NAME" \
            -d "mainBranch=main")

          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d':' -f2)

          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Project created successfully"
          else
            echo "‚ö†Ô∏è  Project creation returned HTTP $HTTP_CODE"
            echo "$RESPONSE" | sed '/HTTP_CODE:/d'
            echo "::warning::Project creation failed but continuing (might already exist)"
          fi

  sonar-analysis:
    name: SonarQube Analysis
    runs-on: ubuntu-latest
    needs:
      - discover-services
      - build-and-test
      - sonar-project-setup
    if: |
      needs.build-and-test.result == 'success' &&
      secrets.SONAR_TOKEN != ''
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.discover-services.outputs.changed-services) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: Cache SonarQube packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: ${{ runner.os }}-gradle

      - name: Build and analyze ${{ matrix.service }} with SonarQube
        working-directory: ${{ matrix.service }}
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          chmod +x gradlew
          ./gradlew build sonar --info
