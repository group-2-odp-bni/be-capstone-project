name: Update Cloudflare DNS

on:
  workflow_dispatch:
    inputs:
      domain:
        description: 'Domain name'
        required: true
        default: 'your-domain.com'

env:
  NAMESPACE: orange-wallet

jobs:
  update-dns:
    name: Update DNS Records
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Get external IP
        id: get-ip
        run: |
          EXTERNAL_IP=$(kubectl get svc nginx-ingress-ingress-nginx-controller -n ingress-nginx -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          echo "external_ip=$EXTERNAL_IP" >> $GITHUB_OUTPUT
          echo "External IP: $EXTERNAL_IP"

      - name: Update DNS records
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          DOMAIN: ${{ github.event.inputs.domain }}
          EXTERNAL_IP: ${{ steps.get-ip.outputs.external_ip }}
        run: |
          # Function to create/update DNS record
          update_dns_record() {
            local subdomain=$1
            local full_domain="${subdomain}.${DOMAIN}"

            echo "Updating DNS record for $full_domain..."

            # Check if record exists
            RECORD_ID=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones/${CLOUDFLARE_ZONE_ID}/dns_records?type=A&name=${full_domain}" \
              -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
              -H "Content-Type: application/json" | jq -r '.result[0].id // empty')

            if [ -n "$RECORD_ID" ] && [ "$RECORD_ID" != "null" ]; then
              # Update existing record
              curl -s -X PUT "https://api.cloudflare.com/client/v4/zones/${CLOUDFLARE_ZONE_ID}/dns_records/${RECORD_ID}" \
                -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
                -H "Content-Type: application/json" \
                --data "{\"type\":\"A\",\"name\":\"${full_domain}\",\"content\":\"${EXTERNAL_IP}\",\"ttl\":1,\"proxied\":true}"

              echo "✅ Updated DNS record for $full_domain"
            else
              # Create new record
              curl -s -X POST "https://api.cloudflare.com/client/v4/zones/${CLOUDFLARE_ZONE_ID}/dns_records" \
                -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
                -H "Content-Type: application/json" \
                --data "{\"type\":\"A\",\"name\":\"${full_domain}\",\"content\":\"${EXTERNAL_IP}\",\"ttl\":1,\"proxied\":true}"

              echo "✅ Created DNS record for $full_domain"
            fi
          }

          # Update DNS records
          update_dns_record "api"
          update_dns_record "auth"

      - name: Verify DNS records
        run: |
          echo "DNS records updated. Waiting for propagation..."
          sleep 30

          echo "Verifying DNS records:"
          dig +short api.${{ github.event.inputs.domain }}
          dig +short auth.${{ github.event.inputs.domain }}
