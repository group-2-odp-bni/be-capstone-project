apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "kafka.fullname" . }}-config
  labels:
    {{- include "kafka.labels" . | nindent 4 }}
data:
  kafka.properties: |
    # KRaft settings
    process.roles={{ .Values.config.processRoles }}
    node.id={{ .Values.kraft.nodeId }}
    controller.quorum.voters={{ .Values.kraft.nodeId }}@localhost:{{ .Values.service.ports.controller }}

    # Listeners
    listeners=INTERNAL://:{{ .Values.service.ports.internal }},CONTROLLER://:{{ .Values.service.ports.controller }},EXTERNAL://:{{ .Values.service.ports.external }}
    advertised.listeners=INTERNAL://{{ include "kafka.fullname" . }}:{{ .Values.service.ports.internal }},EXTERNAL://{{ include "kafka.fullname" . }}:{{ .Values.service.ports.external }}
    listener.security.protocol.map=CONTROLLER:PLAINTEXT,INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT
    inter.broker.listener.name={{ .Values.config.interBrokerListenerName }}
    controller.listener.names={{ .Values.config.controllerListenerNames }}

    # Log settings
    log.dirs={{ .Values.persistence.mountPath }}
    log.retention.hours=168
    log.retention.check.interval.ms=300000
    log.segment.bytes=1073741824
    log.cleanup.policy=delete

    # Replication settings
    offsets.topic.replication.factor={{ .Values.config.offsetsTopicReplicationFactor }}
    transaction.state.log.replication.factor={{ .Values.config.transactionStateLogReplicationFactor }}
    transaction.state.log.min.isr={{ .Values.config.transactionStateLogMinInsyncReplicas }}
    default.replication.factor=1
    min.insync.replicas=1

    # Topic settings
    auto.create.topics.enable={{ .Values.config.autoCreateTopicsEnable }}
    num.partitions=1

    # Group settings
    group.initial.rebalance.delay.ms={{ .Values.config.groupInitialRebalanceDelayMs }}

    # Network and I/O settings
    num.network.threads=3
    num.io.threads=8
    socket.send.buffer.bytes=102400
    socket.receive.buffer.bytes=102400
    socket.request.max.bytes=104857600

    # Compression
    compression.type=producer

    # Metadata
    metadata.max.age.ms=300000

    # Logging
    log4j.logger.kafka=INFO
    log4j.logger.org.apache.kafka=INFO

    # KRaft specific settings
    controller.quorum.election.timeout.ms=1000
    controller.quorum.fetch.timeout.ms=2000
    controller.quorum.election.backoff.max.ms=1000
