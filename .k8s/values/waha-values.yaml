# WAHA Optimized Values - OTP Only Use Case
# Based on research: NOWEB engine for minimal resource usage
# Orange Wallet Production Environment

name: waha
namespace: orange-wallet
replicaCount: 1  # MUST be 1 for WhatsApp session

# Docker Image
image:
  repository: devlikeapro/waha
  tag: latest
  pullPolicy: Always

# Service Configuration
service:
  type: ClusterIP
  port: 3000

# Secrets (using existing waha-secret from secrets.yaml)
secret:
  name: waha-secret
  # These values reference existing secret, no need to redefine
  apiKey: ""
  dashboardUsername: ""
  dashboardPassword: ""
  webhookHmacSecret: ""

# WAHA Configuration - Optimized for OTP
config:
  timezone: "Asia/Jakarta"

  # Based on research: Use GOWS for minimal resource OTP engine
  whatsappEngine: "GOWS"

  # Minimal logging for performance
  logFormat: "PRETTY"  # PRETTY is lighter than JSON
  logLevel: "warn"     # Per research, use warn to reduce verbosity

  # Disable file management (OTP is text-only)
  filesLifetime: 0

  # Webhook - only essential events for OTP
  webhookUrl: "http://notification-worker:8080/api/webhooks/waha"
  # Minimal events: only message.ack for delivery status
  webhookEvents: "message.ack,session.status"

  # Session Management
  autoStartDelay: 3
  restartAllSessions: true
  workerId: "waha-gows-otp" # Changed to gows
  printQR: true

# Persistent Storage - Minimized for OTP use case
persistence:
  # Sessions storage (authentication only)
  sessions:
    enabled: true
    size: 1Gi           # Reduced from 2Gi (sufficient for auth data)
    accessMode: ReadWriteOnce
    mountPath: /app/.sessions

  # Media storage - minimal (OTP doesn't need media)
  media:
    enabled: true
    size: 500Mi         # Reduced from 5Gi (just for temp files)
    accessMode: ReadWriteOnce
    mountPath: /app/.media

# Resource Limits - Aligned with NODE_OPTIONS max-old-space-size
# NODE_OPTIONS requires 200MB + overhead = 256Mi minimum
resources:
  requests:
    memory: "256Mi"
    cpu: "100m"
  limits:
    memory: "512Mi"     # Sufficient headroom for GOWS engine
    cpu: "500m"

# Health Checks - Adjusted for NOWEB
healthcheck:
  liveness:
    initialDelaySeconds: 45   # Increased for Baileys initialization
    periodSeconds: 30
    timeoutSeconds: 10
    failureThreshold: 5       # More tolerant
  readiness:
    initialDelaySeconds: 40   # Increased - NOWEB needs time for Baileys
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 5       # More tolerant

# Additional Environment Variables for Optimization
# Based on comprehensive WAHA optimization research
additionalEnv:
  # Disable file handling (not needed for OTP)
  - name: WAHA_FILES_ENABLED
    value: "false"

  # Disable media download (OTP is text only)
  - name: WHATSAPP_DOWNLOAD_MEDIA
    value: "false"

  # Minimal retries for faster failure detection
  - name: WAHA_SEND_MESSAGE_MAX_RETRIES
    value: "2"

  # Disable unnecessary features
  - name: WAHA_SWAGGER_ENABLED
    value: "false"

  # CRITICAL: Ignore non-essential events (MAJOR CPU/Memory reduction)
  - name: WAHA_SESSION_CONFIG_IGNORE_GROUPS
    value: "true"
  - name: WAHA_SESSION_CONFIG_IGNORE_CHANNELS
    value: "true"
  - name: WAHA_SESSION_CONFIG_IGNORE_STATUS
    value: "true"
  - name: WAHA_SESSION_CONFIG_IGNORE_BROADCAST
    value: "true"

  # Disable dashboard (not needed in production OTP)
  - name: WAHA_DASHBOARD_ENABLED
    value: "false"

  # CRITICAL: API key strategy for health endpoints
  - name: WAHA_HEALTH_MEDIA_FILES_THRESHOLD_MB
    value: "100"
  - name: WAHA_API_KEY_STRATEGY
    value: "WEBHOOK_AND_HEADER"

# Optimization Notes:
# ✅ NOWEB engine: ~50-70% resource reduction vs WEBJS
# ✅ Memory: 128-256MB (vs 512MB WEBJS)
# ✅ Storage: 1.5Gi total (vs 7Gi default)
# ✅ Faster startup: 20-30s (vs 40-60s WEBJS)
# ✅ Perfect for OTP-only use case
# ✅ No Chromium overhead
