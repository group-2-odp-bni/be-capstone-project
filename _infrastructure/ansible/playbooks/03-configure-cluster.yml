---
# =============================================================================
# Playbook: Configure K3s Cluster Post-Installation
# =============================================================================
# Purpose: Apply additional configurations after K3s installation
# Usage: ansible-playbook playbooks/03-configure-cluster.yml
# =============================================================================

- name: Configure K3s Cluster
  hosts: k3s_master
  become: true
  gather_facts: true

  tasks:
    # -------------------------------------------------------------------------
    # Download Kubeconfig
    # -------------------------------------------------------------------------
    - name: Create local kubeconfig directory
      ansible.builtin.file:
        path: "{{ k3s_kubeconfig_local_path | dirname }}"
        state: directory
        mode: '0755'
      delegate_to: localhost
      become: false

    - name: Fetch kubeconfig from master
      ansible.builtin.fetch:
        src: /etc/rancher/k3s/k3s.yaml
        dest: "{{ k3s_kubeconfig_local_path }}"
        flat: yes

    - name: Update kubeconfig server address
      ansible.builtin.replace:
        path: "{{ k3s_kubeconfig_local_path }}"
        regexp: 'https://127.0.0.1:6443'
        replace: "https://{{ ansible_host }}:6443"
      delegate_to: localhost
      become: false

    - name: Display kubeconfig location
      ansible.builtin.debug:
        msg: |
          Kubeconfig downloaded to: {{ k3s_kubeconfig_local_path }}

          To use it:
          export KUBECONFIG={{ k3s_kubeconfig_local_path }}
          kubectl get nodes

    # -------------------------------------------------------------------------
    # Label Nodes
    # -------------------------------------------------------------------------
    - name: Label stateless worker nodes
      ansible.builtin.command: >
        kubectl label nodes {{ item }}
        workload-type=stateless
        --overwrite
      loop: "{{ groups['k3s_workers_stateless'] }}"
      changed_when: true

    - name: Label stateful worker node
      ansible.builtin.command: >
        kubectl label nodes {{ item }}
        workload-type=stateful
        database-node=true
        --overwrite
      loop: "{{ groups['k3s_workers_stateful'] }}"
      changed_when: true

    # -------------------------------------------------------------------------
    # Taint Stateful Node
    # -------------------------------------------------------------------------
    - name: Taint stateful worker node
      ansible.builtin.command: >
        kubectl taint nodes {{ item }}
        stateful=true:NoSchedule
        --overwrite
      loop: "{{ groups['k3s_workers_stateful'] }}"
      changed_when: true

    # -------------------------------------------------------------------------
    # Verify Configuration
    # -------------------------------------------------------------------------
    - name: Get nodes with labels
      ansible.builtin.command: kubectl get nodes --show-labels
      register: nodes_labels
      changed_when: false

    - name: Display node labels
      ansible.builtin.debug:
        var: nodes_labels.stdout_lines

    - name: Get node taints
      ansible.builtin.command: kubectl get nodes -o custom-columns=NAME:.metadata.name,TAINTS:.spec.taints
      register: nodes_taints
      changed_when: false

    - name: Display node taints
      ansible.builtin.debug:
        var: nodes_taints.stdout_lines

    # -------------------------------------------------------------------------
    # Create Namespaces
    # -------------------------------------------------------------------------
    - name: Create infrastructure namespaces
      kubernetes.core.k8s:
        name: "{{ item }}"
        api_version: v1
        kind: Namespace
        state: present
      loop:
        - argocd
        - nginx-ingress
        - cert-manager
        - external-secrets
        - observability
        - database
        - messaging

    - name: Display configuration complete message
      ansible.builtin.debug:
        msg: |
          ========================================
          K3s Cluster Configuration Complete!
          ========================================

          Cluster is ready for GitOps deployment with ArgoCD.

          Next steps:
          1. Install ArgoCD: kubectl apply -n argocd -f argocd-install.yaml
          2. Deploy infrastructure components via ArgoCD
          3. Deploy application services
